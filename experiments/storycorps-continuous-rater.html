<!DOCTYPE html>
<html>
<head>
    <title>Storycorps Audio Rating Experiment</title>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> 

    <!-- LOAD FINNLAB SPECIFIC THINGS --> 
    <script src="https://rcweb.dartmouth.edu/~f003rjw/jspsych_experiments/utils/javascript_utils.js" type="text/javascript"></script>

    <!-- FOR LOADING EXTENSIONS --> 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
    <script src="comprehension-check-plugin.js"></script>
    <script src="pinknoise-rating-plugin.js"></script>
    <script src="practice-pinknoise-rating-plugin.js"></script>
    <script src="negation-rating-plugin.js"></script>
    <script src="practice-negation-rating-plugin.js"></script>
    <script src="highest-lowest-rating-plugin.js"></script>

</head>
<body>
    <script>

        //////////////////////////////////////////
        ////// GENERAL EXPERIMENT FUNCTIONS //////
        //////////////////////////////////////////
        
        EXPERIMENT_NAME = 'storycorps-continuous-rater'
        let STIMULUS;
        let PRACTICE_STIMULUS;

        // we will change this later to be loaded in through experiment_info variable
        WRITE_DATA_URL = 'https://rcweb.dartmouth.edu/~f003rjw/jspsych_experiments/utils/write_data.php'
        OUTPUT_PATH = '/dartfs/rc/lab/F/FinnLab/public_html/data/'

        function saveData(SUB_ID){
            // Call this function at the end of trials to save out data
            // may need to be modified because the amount of data we're saving here
            // is much larger than other experiments
            console.log(pathJoin(parts=[
                    OUTPUT_PATH, 
                    EXPERIMENT_NAME,
                    SUB_ID,
                ]))
            saveExperimentData(
                jsPsych = jsPsych, 
                write_data_url = WRITE_DATA_URL, 
                output_path = pathJoin(parts=[
                    OUTPUT_PATH, 
                    EXPERIMENT_NAME,
                    SUB_ID,
                ]), 

                // WE WILL WANT TO UPDATE THIS
                output_filename = [SUB_ID, '_storycorps-continuous-rater'].join(''),
            );
        }


        // Function to load stimulus files after sub_id is set
        function loadStimulusFiles(SUB_ID) {

            stimulus_fn = [
                'https://rcweb.dartmouth.edu/FinnLab/dallas/projects/storycorps-continuous-rater/audio-file-orders/', 
                SUB_ID,
                '_storycorps-continuous-rater.json'].join('')

            practice_stimulus_fn = [
                'https://rcweb.dartmouth.edu/FinnLab/dallas/projects/storycorps-continuous-rater/practice-audio-file-orders/', 
                SUB_ID,
                '_storycorps-continuous-rater.json'].join('')

            // use jquery to load the json file
            $.ajax({
                url: stimulus_fn,
                dataType: 'json',
                type: 'get',
                cache: true,
                async: false,
                success: function (data) {
                    stimulus = data; // all information from the json is loaded into the variable stimulus
                }
            });

            // use jquery to load the json file
            $.ajax({
                url: practice_stimulus_fn,
                dataType: 'json',
                type: 'get',
                cache: true,
                async: false,
                success: function (practice_data) {
                    practice_stimulus = practice_data; // all information from the json is loaded into the variable practice_stimulus
                }
            });

            // replace the /dartfs/ paths with those accessible through rc-web
            html_string = "https://rcweb.dartmouth.edu/FinnLab/"
            replace_string = "/dartfs/rc/lab/F/FinnLab/"
            
            stimulus.forEach(item => item.stimulus = item.stimulus.replace(replace_string, html_string))
            practice_stimulus.forEach(item => item.practice_stimulus = item.practice_stimulus.replace(replace_string, html_string))

            return {stimulus,  practice_stimulus}
        }
        
        /////////////////////////////////////////
        //////// START JSPSYCH INSTANCE  ////////
        /////////////////////////////////////////
        // Create timeline
        var timeline = [];

        // Initialize jsPsych
        var jsPsych = initJsPsych({
            on_finish: function() {
                jsPsych.data.displayData();
            },
            on_close: function(){ 
                alert("The experiment isn't finished. Are you sure you want to leave the page?");
            },
            on_finish: function() {
                // JUST FOR TESTING --> REMOVE WHEN RUNNING AN ACTUAL EXPERIMENT
                jsPsych.data.displayData();
            }
        });

        // welcome page
        var welcome = {
            type: jsPsychInstructions,
            pages: [
            'Welcome to the experiment. Click the button to begin.',
            ],
            show_clickable_nav: true,
            data: {function: 'Welcome' }
        };
        // timeline.push(welcome);
        
        /////////////////////////////////////////
        //// PINK NOISE INSTR. and PRAC /////////
        /////////////////////////////////////////

        var pinknoise_rating_box = '<img src="https://rcweb.dartmouth.edu/FinnLab/dallas/projects/storycorps-continuous-rater/experiments/pinknoise-rating-box.png" style="width:800px;height:auto;">';
        var keyboard_image = '<img src="https://rcweb.dartmouth.edu/FinnLab/dallas/projects/storycorps-continuous-rater/experiments/keyboard.png" style="width:400px;height:auto;">';

        var pinknoise_instructions = {
            type: jsPsychInstructions,
            pages: [
                'In this experiment, you’ll be listening to the StoryCorps One Small Step conversation that you recorded a few days ago.',
                'As you listen, <b>try to remember how you felt at each moment of the conversation.</b> <br><br> You’ll be asked to provide a continuous rating of how much you were enjoying the conversation as it progressed.',
                'To calibrate, <b>think of what a really enjoyable conversation feels like to you.</b> Maybe it’s talking with your best friend about a show you both like, or meeting a stranger you really hit it off with at a party. <b>Keep that feeling in mind as the maximum rating you could give.</b>',
                'Now, <b>think of what a really unenjoyable conversation feels like to you.</b> Maybe it’s an awkward conversation with an untidy roommate, or an argument with a family-member. <b>Keep that feeling in mind as the minimum rating you could give.</b>',
                '<i>When you understand what you will be rating, please press next.</i><br><br>',
                'To provide your continuous ratings, you will use a rating box that looks like the one below while listening to each audio clip:<br><br>' + pinknoise_rating_box,
                'You will use the up and down arrow keys on your keyboard to adjust the rating to reflect how much you were enjoying the conversation at a given point.<br><br>' 
                + keyboard_image + '<br>' + '<br><br>' +
                'You will always be able to view the past 20 seconds of your ratings.',
                'Use the <b>up arrow</b> on your keyboard to record whenever there was an <b>increase</b> in how much you enjoyed the conversation.',
                'Use the <b>down arrow</b> on your keyboard to record whenever there was a <b>decrease</b> in how much you enjoyed the conversation.',
                'Let us now practice using your keyboard to indicate your rating.',
            ],
            show_clickable_nav: true,
        };

        var use_up = {
            type: jsPsychHighestLowestRating,
            rating_width: 800,
            rating_height: 200,
            rating_name: "enjoyment",
            high_end: "Most Enjoyment",
            low_end: "Least Enjoyment",
            initial_rating: 50,
            rating_history_length: 800,
            direction: 'up',
            on_finish: function(){
                saveData(SUB_ID)
            }
        };

        var great_up = {
        type: jsPsychInstructions,
        pages: [
            'Great! You just indicated the most enjoyment.',
        ],
        show_clickable_nav: true,
        };

        var use_down = {
            type: jsPsychHighestLowestRating,
            rating_width: 800,
            rating_height: 200,
            rating_name: "enjoyment",
            high_end: "Most Enjoyment",
            low_end: "Least Enjoyment",
            initial_rating: 50,
            rating_history_length: 800,
            direction: 'down',
            on_finish: function(){
                saveData(SUB_ID)
            }
        };

        var great_down = {
        type: jsPsychInstructions,
        pages: [
            'Great! You just indicated the least enjoyent.'
        ],
        show_clickable_nav: true,
        };

        var pinknoise_instructions_and_prac = {
            timeline: [
                pinknoise_instructions,
                use_up,
                great_up,
                use_down,
                great_down,
            ],
        }
        // timeline.push(pinknoise_instructions_and_prac);

        /////////////////////////////////////////
        ////// NEGATION INSTR. and PRAC /////////
        /////////////////////////////////////////

        var negation_rating_example = '<img src="https://rcweb.dartmouth.edu/FinnLab/dallas/projects/storycorps-continuous-rater/experiments/negation-rating-example.png" style="width:800px;height:auto;">';
        
        var negation_instructions = {
            type: jsPsychInstructions,
            pages: [
                'At various intervals, you will be interrupted and asked how well you were understood by your partner and how well your partner was understood by you.',
                'To calibrate, think of what feeling understood vs misunderstood by your partner means to you. How accurate do you think strangers’ predictions about you are at baseline?',
                'Now consider telling someone a story about participating in team sports a child. How understood would you feel if your partner asked about the role of teamwork or physical fitness in your adult life?',
                '<i>When you understand what you will be rating, please press next.</i><br><br>',
                'To provide your ratings, you will use two side-by-side scales numbered 0-10: <br><br>' + negation_rating_example,
                'You will use the each scale to rate how well you understood your partner and how well your partner understood you, respectively.',
                '<i>When you understand what you will be rating, please press next.</i><br><br>',
            ],
            show_clickable_nav: true,
        };

        var practice_trial_precursor = {
            type: jsPsychInstructions,
            pages: [
                "Great! You will now complete practice trials.",
                "For the practice trials, please provide answers <b>from the perspective of the male speaker.</b>",
                "Remember to use your arrow keys to provide continuous ratings. <br><br> <b>Press next when you are ready to begin.</b>",
            ],
            show_clickable_nav: true
        }

        var negation_instructions_and_prac = {
            timeline: [
                negation_instructions,
                practice_trial_precursor,
            ],
        }
        // timeline.push(negation_instructions_and_prac);

        /////////////////////////////////////////
        ///////// FULL PRACTICE TRIAL ///////////
        /////////////////////////////////////////  
        var practice_initial_rating = 50;
        var practice_rating_history_length = 1500;
        var practice_rating_history = new Array(practice_rating_history_length).fill(practice_initial_rating);

        var practice_noIndicatorMovement = false;
        var practice_elapsed_time = 0
        var practice_max_time_no_movement = 30

        var practice_pinknoise = {
            type: jsPsychPracticePinknoiseRating,
            sources: [jsPsych.timelineVariable('practice_stimulus')],
            rating_width: 800,
            rating_height: 200,
            practice_initial_rating: practice_initial_rating,
            practice_rating_history_length: practice_rating_history_length,
            practice_rating_history: practice_rating_history,
            practice_noIndicatorMovement: practice_noIndicatorMovement,
            practice_max_time_no_movement: practice_max_time_no_movement,
            practice_elapsed_time: practice_elapsed_time,
            on_start: function(trial) {
                trial.practice_initial_rating = practice_initial_rating
                trial.practice_rating_history = practice_rating_history
                trial.practice_noIndicatorMovement = practice_noIndicatorMovement
                trial.practice_elapsed_time = practice_elapsed_time
            },
            on_finish: function(trial){
                practice_noIndicatorMovement = trial.practice_noIndicatorMovement;
                practice_elapsed_time = trial.practice_elapsed_time;
                saveData(SUB_ID);
            }
        };

        var practice_negation = {
            type: jsPsychPracticeNegationRating,
        };

        // // Variable for checking whether there's another trial
        var practice_currentTrialIndex = 0;

        // Function to check if there is a next trial
        function practiceHasNextTrial() {
            return practice_currentTrialIndex < PRACTICE_STIMULUS.length - 1;
        }

        // After a trial display this screen to let participant prepare
        var next_trial = {
          type: jsPsychHtmlButtonResponse,
          stimulus: '<div style="max-width:600px;"><p>Press continue when you are ready for the next trial.</p></div>',
          choices: ['Continue']
        }

        // Next trial conditional function
        var practice_next_trial_conditional = {
            timeline: [next_trial],
            conditional_function: function(){
                if(practiceHasNextTrial()){
                    return true;
                } else {
                    return false;
                }
            },
            on_finish: function(){
                practice_currentTrialIndex++;
            }
        };

        // After a trial display this screen to let participant prepare
        var no_movement = {
          type: jsPsychHtmlButtonResponse,
          stimulus: '<div style="max-width:600px;"><p>You have not updated your rating in one minute, please remember to update your ratings.</p></div>',
          choices: ['Continue']
        }

        // No movement conditional function
        var practice_no_movement_conditional = {
            timeline: [no_movement],
            conditional_function: function(){
                if(practice_elapsed_time >= practice_max_time_no_movement){
                    return true;
                } else {
                    return false;
                }
            },
        };

        // timeline.push(practice_rating_procedure_loop);

        /////////////////////////////////////////
        ////////////// REAL TRIALS //////////////
        /////////////////////////////////////////
        
        var post_practice_message = {
            type: jsPsychInstructions,
            pages: [
                "Great job! Next, you will begin the <b>actual experiment.</b>",
            ],
            show_clickable_nav: true
        }
        // timeline.push(post_practice_message);

        var initial_rating = 50;
        var rating_history_length = 1500;
        var rating_history = new Array(rating_history_length).fill(initial_rating);
        
        var noIndicatorMovement = false;
        var elapsed_time = 0
        var max_time_no_movement = 60

        var pinknoise_trial = {
            type: jsPsychPinknoiseRating,
            sources: [jsPsych.timelineVariable('STIMULUS')],
            rating_width: 800,
            rating_height: 200,
            initial_rating: initial_rating,
            rating_history_length: rating_history_length,
            rating_history: rating_history,
            noIndicatorMovement: noIndicatorMovement,
            max_time_no_movement: max_time_no_movement,
            elapsed_time: elapsed_time,
            on_start: function(trial) {
                trial.initial_rating = initial_rating
                trial.rating_history = rating_history
                trial.noIndicatorMovement = noIndicatorMovement
                trial.elapsed_time = elapsed_time
            },
            on_finish: function(trial){
                noIndicatorMovement = trial.noIndicatorMovement;
                elapsed_time = trial.elapsed_time;
                saveData(SUB_ID);
            }
        };

        var negation_trial = {
            type: jsPsychNegationRating,
        };

        // Variable for checking whether there's another trial
        var currentTrialIndex = 0;

        // Function to check if there is a next trial
        function hasNextTrial() {
            return currentTrialIndex < STIMULUS.length - 1; // if returns True, show next trial screen
        }

        // Next trial conditional function
        var next_trial_conditional = {
            timeline: [next_trial],
            conditional_function: function(){
                if(hasNextTrial()){
                    return true;
                } else {
                    return false;
                }
            },
            on_finish: function(){
                currentTrialIndex++;
            }
        };

        // No movement conditional function
        var no_movement_conditional = {
            timeline: [no_movement],
            conditional_function: function(){
                if(elapsed_time >= max_time_no_movement){
                    return true;
                } else {
                    return false;
                }
            },
        };

        var rating_procedure_loop = {
            timeline: [
                pinknoise_trial,
                negation_trial,
                no_movement_conditional,
                next_trial_conditional
            ],
            timeline_variables: STIMULUS,
        }
        // timeline.push(rating_procedure_loop);

        var exp_end = {
          type: jsPsychHtmlButtonResponse,
          stimulus: '<div style="max-width:600px;"><p>Thank you for your participation! Please press "finish" and <b>do not exit out of the browser.</b> Thank you!</p></div>',
          choices: ['Finish']
        }
        // timeline.push(exp_end);

        function createExperiment(sub_id, practice_stimulus){

            console.log(practice_stimulus)

            var practice_rating_procedure_loop = {
                timeline: [
                    practice_pinknoise,
                    practice_negation,
                    practice_no_movement_conditional,
                    practice_next_trial_conditional
                ],
                timeline_variables: practice_stimulus,
            }

            trials = [
                welcome,
                // pinknoise_instructions_and_prac,
                practice_rating_procedure_loop,
            ]

            for (let i = 0; i < trials.length; i++) {
                jsPsych.addNodeToEndOfTimeline(trials[i]);
            }
        }

        // input SUB_ID
        var input_id = {
            type: jsPsychSurveyText,
            questions: [
                {
                    prompt: 'Please enter your subject ID',
                    name: "sub_id",
                    required: true
                },
            ],
            on_finish: function(data) {
                SUB_ID = jsPsych.data.get().last(1).select('response').values[0].sub_id;
                STIMULUS = loadStimulusFiles(SUB_ID).stimulus;
                PRACTICE_STIMULUS = loadStimulusFiles(SUB_ID).practice_stimulus;

                createExperiment(SUB_ID, PRACTICE_STIMULUS);
            }
        };
        
        timeline.push(input_id);

        // Run the experiment
        jsPsych.run(timeline);

    </script>
</body>
</html>